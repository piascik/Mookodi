# Mookodi Camera Server

This directory contains the source code for a C++ server with a thrift interface, that uses the CCD library to drive the Mookodi Andor CCD camera.

## Directory structure

* **interface** This contains the thrift interface file, used to generate the thrift interface source code.
* **server** This contains the C++ source code to build the MookodiCameraServer binary.
* **server/interface** This contains the Makefile for building the thrift interface sources. The sources themselves are generated by running the thrift interface compiler on the interface file in the **interface** directory.
* **mookodi** This is the head of python2/3 camera client software. The actual camera client's are in the **mookodi/camera/client** directory (the directory structure enabling the clients to be in a sensible package hierarchy).

## Installing the client code

setup.py has to be invoked to install the client side python libraries. Assuming the Mookodi repo has been cloned into the /home/dev/src/ directory, this can be invoked like this:

* cd /home/dev/src/Mookodi/camera
* sudo tcsh -c "source /home/dev/src/Mookodi/mookodi_environment.csh; python3 setup.py develop"

## Dependencies / Prerequisites

Currently, the package can be built on Ubuntu 18.04 or Ubuntu 20.04. A version of the Andor SDK2 is required for CCD camera control, and CFITSIO is used to write FITS images.

The server interfaces are written using thrift, which needs to be installed.

Other software packages that were installed on the mookodi machine to facilitate building the camera server include:

* **tcsh** *sudo apt install tcsh* The environment setup script is currently written in tcsh.
* **emacs** *sudo apt-get  install emacs* Used for editing.
* **python-setuptools** *sudo apt-get install python3-setuptools* / *sudo apt-get install python-setuptools* Used whilst installing the python client packages.
* **pip** *sudo apt install python3-pip* Used for requests installation
* **requests** *sudo pip3 install requests* Used by the thrift python libraries.
* **boost** Used by the camera C++ server.
* **log4cxx** Used for logging by the camera C++ server.
* **doxygen** *sudo apt-get install doxygen* *sudo apt-get install graphviz* Used for C library and camera server documentation. You need graphviz for dot, which doxygen attempts to use.
* **plibsys** Installed from https://github.com/saprykin/plibsys . Used to provide config file support.

## Running the server

Assuming the Mookodi repo has been cloned into the /home/dev/src/ directory and built, the MookodiCameraServer can be started as follows:

* tcsh
* source /home/dev/src/Mookodi/mookodi_environment.csh
* cd /home/dev/src/Mookodi/bin/mookodi/camera/server/x86_64-linux
* ./MookodiCameraServer --config_file /home/dev/src/Mookodi/config/mkd.cfg

If there is no Andor camera present, the server can be started in emulation mode for testing purposes:

* ./MookodiCameraServer --config_file /home/dev/src/Mookodi/config/mkd.cfg --emulate_camera

The server creates a log file at: /mookodi/logs/mookodi_camera_server.log , which is rolled hourly. See /home/dev/src/Mookodi/bin/mookodi/camera/server/log4cxx.properties for details.

## Running the command-line clients

There is a series of command line clients that can be used for camera testing. Assuming the Mookodi repo has been cloned into the /home/dev/src/ directory and setup.py run, they can be run as follows:

* tcsh
* source /home/dev/src/Mookodi/mookodi_environment.csh
* cd /home/dev/src/Mookodi/camera/mookodi/camera/client
* Run the command line test program. Available programs:
  * ***abort_exposure3.py***  - Abort a previously started bias/dark/exposure.
  * ***add_fits_header3.py*** - Add a FITS header keyword/value to the internally maintained list.
  * ***clear_fits_headers3.py*** - Clear the internally maintained list of FITS headers
  * ***clear_window3.py*** - Clear any sub-image windows defined - make the detector read out full-frame.
  * ***cool_down3.py*** - Start the camera cooling down.
  * ***do_biases.py*** - Do a defined set of bias frames.
  * ***do_darks.py*** - Do a defined set of dark frames.
  * ***get_image_data3.py*** - Exercises the get_image_data API, which returns the read out data in memory.
  * ***get_last_image_filename3.py*** - Get the filename of the last FITS image saved by the server.
  * ***get_state3.py*** - Get and print out the current state of the server/camera/camera temperature.
  * ***multbias3.py*** - Take a series of bias frames.
  * ***multdark3.py*** - Take a series of dark frames
  * ***multrun3.py*** - Take a series of exposures.
  * ***set_binning3.py*** - Set the detector binning.
  * ***set_gain3.py*** - Set the detector gain.
  * ***set_readout_speed3.py*** - Set how quickly the detector is read out.
  * ***set_window3.py*** - Set a sub-image of the full frame to read out.
  * ***soak_test.py*** - Do a series of exposures to test the camera server.
  * ***start_bias3.py*** - Start taking a bias frame. Use get_state3.py to monitor for completion.
  * ***start_dark3.py*** - Start taking a dark frame. Use get_state3.py to monitor for completion.
  * ***start_expose3.py*** - Start taking an exposure.  Use get_state3.py to monitor for completion.
  * ***warm_up3.py*** - Start warming up the detector to ambient.

## Example usage sequence:

In one terminal (the 'server' terminal), follow the instructions in the 'Running the server' section
to start the server.

Setup the running environment in a second 'client' terminal:

* tcsh
* source /home/dev/src/Mookodi/mookodi_environment.csh
* cd /home/dev/src/Mookodi/camera/mookodi/camera/client

Cool down the camera and configure it:

* ./cool_down3.py
* ./clear_window3.py (or use ./set_window3.py <x_start> <y_start> <x_end> <y_end>)
* ./set_gain3.py ONE
* ./set_readout_speed3.py FAST
* ./set_binning3.py 1 1

Monitor the camera temperature until it is cool:

* ./get_state3.py

Setup any FITS headers as required. The camera software itself provides a basic set of FITS headers, which can be added to:

* ./add_fits_header3.py USER STRING "Chris" "Who is using the camera"
* ./add_fits_header3.py MYNUM INTEGER 1 "An integer number"
* ./add_fits_header3.py MYNUM2 DOUBLE 2.0 "An double number"

Start taking an exposure:

* ./start_expose3.py 10000 --save_image

The exposure length is in milliseconds. --save_image will store the resultant data in a FITS image file.
Alternatively a bias or a dark can be taken instead as follows:

* ./start_bias3.py
* ./start_dark3.py 10000

Monitor the exposure progress until it is complete:

* ./get_state3.py

Get the last FITS filename generated (assuming you told the server to save the image above):

* ./get_last_image_filename3.py

Once you have finished using the camera, you can warm it up as follows:

* ./warm_up3.py

And again, monitor the temperature with:

* ./get_state3.py

This is just the lowest level of interaction with the camera server, for a more complete interaction with the instrument (moving the mechanisms, proper propagation of TCS FITS headers) higher level software should be used.
